#
# Library functions used in the goals below
#

@lib templating
  from-template() { 
    config="./.env"
    template="$1"
    destination="$2"

    cp "$template" "$destination"

    while read line; do
      setting="$( echo "$line" | cut -d '=' -f 1 )"
      value="$( echo "$line" | cut -d '=' -f 2- )"
      sed -i -e "s;%${setting}%;${value};g" "$destination"
    done < "$config"
  }

###
# Make sure system dependencies are installed
###

@goal dependencies_installed
@doc Installs all dependencies
@depends_on docker_installed
@depends_on docker_compose_installed

# Docker
@goal docker_installed
@doc Installs Docker from the install script
@reached_if which docker > /dev/null 2>&1
  curl -fsSL https://get.docker.com -o /tmp/get-docker.sh
  sudo sh /tmp/get-docker.sh
  rm /tmp/get-docker.sh
  sudo usermod -aG docker pi

# Docker Compose
@goal docker_compose_installed
@doc Installs docker-compose from pip3
@reached_if which docker-compose > /dev/null 2>&1
  sudo apt-get install -y libffi-dev libssl-dev python3-dev python3 python3-pip
  sudo pip3 install docker-compose

###
# Make sure config files needed to get everything running are generated
###

@goal config_configured
@doc Ensures everything is configured
@depends_on caddy_configured
@depends_on host_dns_configured

@goal caddy_configured
@doc Generates the caddy config from the template, substituting in any secrets from .env
@use_lib templating
    from-template caddy/Caddyfile.template caddy/Caddyfile

@goal host_dns_configured
@doc Ensures that the host Raspberry Pi has DNS servers other than the Unfi provided Pi Hole to avoid circular dependencies which could stop networking happening
@reached_if grep "# START HOMELAB GENERATED" /etc/resolvconf.conf > /dev/null 2>&1
  cat << EOF | sudo tee -a /etc/resolvconf.conf
# START HOMELAB GENERATED
name_servers=1.1.1.1
# END HOMELAB GENERATED
EOF
  sudo resolvconf -u

###
# Ensure all services are running
###

@goal running
@depends_on docker_compose_running

@goal docker_compose_running
@doc Ensures the docker compose services are running
@reached_if docker container ls | grep caddy > /dev/null 2>&1
  docker-compose up -d

###
# Make sure all services are configured after they are running
###

@goal configured
@depends_on dns_configured

@goal dns_configured
@doc Ensures the custom DNS is configured in Pihole to point to the right internal IP for the services
  source ./.env
  cat << EOF > ./pihole/data/custom.list
$HOST_IP pihole.$DOMAIN
$HOST_IP unifi.$DOMAIN
EOF

###
# The default goal which ensures that everything is set up and running correctly
###

@goal default
@depends_on dependencies_installed
@depends_on config_configured
@depends_on running
@depends_on configured
